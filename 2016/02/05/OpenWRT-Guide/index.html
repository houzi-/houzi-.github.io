<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  <link href="//fonts.googleapis.com/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">



<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=0.5.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="OpenWRT,路由器," />





  <link rel="alternate" href="/atom.xml" title="HOUZI的博客" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=0.5.0" />






<meta name="description" content="配置编译环境必须使用非root用户，ArchLinux需要创建新用户。
安装依赖包// Ubuntu 14.04 必选
# apt-get install asciidoc bash bc binutils bzip2 fastjar flex git-core g++ build-essential util-linux gawk libgtk2.0-dev intltool jikespg z">
<meta property="og:type" content="article">
<meta property="og:title" content="OpenWRT Guide">
<meta property="og:url" content="http://yoursite.com/2016/02/05/OpenWRT-Guide/index.html">
<meta property="og:site_name" content="HOUZI的博客">
<meta property="og:description" content="配置编译环境必须使用非root用户，ArchLinux需要创建新用户。
安装依赖包// Ubuntu 14.04 必选
# apt-get install asciidoc bash bc binutils bzip2 fastjar flex git-core g++ build-essential util-linux gawk libgtk2.0-dev intltool jikespg z">
<meta property="og:updated_time" content="2016-02-14T00:52:02.195Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="OpenWRT Guide">
<meta name="twitter:description" content="配置编译环境必须使用非root用户，ArchLinux需要创建新用户。
安装依赖包// Ubuntu 14.04 必选
# apt-get install asciidoc bash bc binutils bzip2 fastjar flex git-core g++ build-essential util-linux gawk libgtk2.0-dev intltool jikespg z">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 9160649,
      author: '博主'
    }
  };
</script>

  <title> OpenWRT Guide | HOUZI的博客 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  








  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">HOUZI的博客</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu ">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-th fa-fw"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-guestbook">
          <a href="/guestbook" rel="section">
            
              <i class="menu-item-icon fa fa-question-circle fa-fw"></i> <br />
            
            留言
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-user fa-fw"></i> <br />
            
            关于
          </a>
        </li>
      

      
      
      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                OpenWRT Guide
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-02-05T21:20:36+08:00" content="2016-02-05">
              2016-02-05
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/OpenWRT/" itemprop="url" rel="index">
                    <span itemprop="name">OpenWRT</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/02/05/OpenWRT-Guide/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/02/05/OpenWRT-Guide/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2016/02/05/OpenWRT-Guide/" class="leancloud_visitors" data-flag-title="OpenWRT Guide">
               &nbsp; | &nbsp;
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">阅读次数 </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="u914D_u7F6E_u7F16_u8BD1_u73AF_u5883"><a href="#u914D_u7F6E_u7F16_u8BD1_u73AF_u5883" class="headerlink" title="配置编译环境"></a>配置编译环境</h2><p>必须使用<strong>非root用户</strong>，ArchLinux需要创建新用户。</p>
<h3 id="u5B89_u88C5_u4F9D_u8D56_u5305"><a href="#u5B89_u88C5_u4F9D_u8D56_u5305" class="headerlink" title="安装依赖包"></a>安装依赖包</h3><pre><code>// Ubuntu 14.04 必选
# apt-get install asciidoc bash bc binutils bzip2 fastjar flex git-core g++ build-essential util-linux gawk libgtk2.0-dev intltool jikespg zlib1g-dev genisoimage libncurses5-dev libssl-dev patch perl-modules python2.7-dev rsync ruby sdcc unzip wget gettext xsltproc libboost1.55-dev libboost1.55-tools-dev libxml-parser-perl libusb-dev bin86 bcc bzr ecj sharutils openjdk-7-jdk zip gcc-multilib quilt
// Ubuntu 14.04 可选
# apt-get install subversion mercurial cvs
// ArchLinux 必选
# pacman -S base-devel
# pacman -S [--needed] asciidoc b43-fwcutter bash bc bin86 boost binutils bzip2 cdrkit fastjar flex gawk gettext git gtk2 intltool jdk7-openjdk libusb libxslt ncurses openssl patch perl python2 rsync ruby sdcc sharutils unzip util-linux wget zlib gcc make perl-extutils-makemaker findutils libstdc++5 lib32-libstdc++5
// libstdc++  可能需要版本6,待测
// 根据wiki，ArchLinux部分必选包在AUR里面
// 从 2015-12-11 开始，bcc和jikes貌似从AUR里消失了，可能是 C++ ABI 更新的缘故，不安装这两个貌似也可以
$ yaourt -S bcc jikes
// ArchLinux 可选
# pacman -S subversion
</code></pre><a id="more"></a>
<h3 id="u9996_u6B21_u914D_u7F6E_u9700_u8981_u68C0_u51FA_u6E90_u4EE3_u7801_uFF0C_u8FD9_u91CC_u7528subversion_u68C0_u51FA_u5F00_u53D1trunk_u5206_u652F"><a href="#u9996_u6B21_u914D_u7F6E_u9700_u8981_u68C0_u51FA_u6E90_u4EE3_u7801_uFF0C_u8FD9_u91CC_u7528subversion_u68C0_u51FA_u5F00_u53D1trunk_u5206_u652F" class="headerlink" title="首次配置需要检出源代码，这里用subversion检出开发trunk分支"></a>首次配置需要检出源代码，这里用subversion检出开发trunk分支</h3><pre><code>$ svn co svn://svn.openwrt.org/openwrt/trunk/
</code></pre><p>这时，就会出现名为<code>trunk</code>的文件夹，这就是将来我们的工作目录。<br>如果已经有了以前的版本库，需要按照下面的命令更新</p>
<pre><code>// 必须进入工作目录才能更新
$ cd trunk/
$ svn update
</code></pre><h3 id="u66F4_u65B0_u548C_u5B89_u88C5feeds_uFF08_u9700_u8981VPN_uFF09"><a href="#u66F4_u65B0_u548C_u5B89_u88C5feeds_uFF08_u9700_u8981VPN_uFF09" class="headerlink" title="更新和安装feeds（需要VPN）"></a>更新和安装feeds（需要VPN）</h3><p>在下载之前可以通过查看<code>feeds.conf.default</code>文件，来检查哪些文件需要包含在环境中。更新只需要重复命令即可</p>
<pre><code>$ cd trunk/
$ ./scripts/feeds update -a
$ ./scripts/feeds install -a
</code></pre><h3 id="u914D_u7F6E_u7F16_u8BD1_u4FE1_u606F"><a href="#u914D_u7F6E_u7F16_u8BD1_u4FE1_u606F" class="headerlink" title="配置编译信息"></a>配置编译信息</h3><p>必须先选择好目标（target）类型才能执行 <code>make defconfig</code></p>
<pre><code>$ make defconfig
$ make prereq
$ make menuconfig
</code></pre><p>其中斜线（/）可以进行搜索。<br>刚开始可以考虑选择编译SDK用于开发，编译ImageGenerator（a.k.a ImageBuilder）简单打包自己需要的Package和配置文件进入固件中，也可以同时打包好工具链（ToolChain）方便以后使用，这样的话时间会稍微长一些。  </p>
<h2 id="u5F00_u59CB_u7F16_u8BD1"><a href="#u5F00_u59CB_u7F16_u8BD1" class="headerlink" title="开始编译"></a>开始编译</h2><p>一般情况，进行全部编译时使用一个简单的命令，因为编译过程会下载很多文件，目前许多项目的repo都迁移到GitHub上了，一般情况下不必使用VPN，但是如果网络条件很差，可以考虑使用一个靠谱的VPN服务提供商。</p>
<pre><code>$ make V=99
</code></pre><p>编译一个单独的软件包（例如cups软件包）</p>
<pre><code>$ make package/cups/compile V=99
</code></pre><p>如果特殊原因需要分析编译报错信息：</p>
<pre><code>$ make V=99 2&gt;&amp;1 |tee build.log |grep -i error
</code></pre><p>则将编译的所有输出信息保存在<code>build.log</code>中，将error信息打印在屏幕上。</p>
<p>还发现一个记录log的好办法，打开<code>make menuconfig</code>里面的Advanced configuration options (for developers)，接着开启Enable log files during build process，这样在使用<code>make V=99</code>的时候自动会生成logs文件夹，里面详细记录了各个阶段的日志文件，相比上述输出日志的形式，这种更加全面，实际使用过程发现好像反应稍微慢了点，不过没有错误才是最好的，不是么？</p>
<h3 id="u7F16_u8BD1_u7ED3_u675F"><a href="#u7F16_u8BD1_u7ED3_u675F" class="headerlink" title="编译结束"></a>编译结束</h3><p>编译结束后，所有的文件都会放在编译根目录下的 bin/yourtarget/ ，例如 /bin/ar71xx</p>
<pre><code>$ ls bin/*
</code></pre><p>编译之后的文件主要有以下几类：</p>
<ol>
<li>bin/.trx 文件: 路由器固件。如果没有另外一种也不必惊慌。关于.bin和.trx的区别，一种说法是，第一次刷路由器的时候，需要用.bin文件，如果需要再升级，则不能再使用 .bin文件，而需要用 .trx文件。原因是 .bin是将路由器的相关配置信息和 .trx封装在一起而生成的封包，也就是说是包含路由器版本信息的 .trx 在第一次刷固件的时候，我们需要提供这样的信息，而在后续升级时则不再需要，用 .trx文件即可。</li>
<li>packages文件夹: 里面包含了我们在配置文件里设定的所有编译好的软件包。</li>
<li>（可选）OpenWrt-SDK.**.tar.bz2: 这个也就是我们定制编译好的OpenWRT SDK环境。我们将用这个来进行OpenWrt软件包的开发。我的 TP-Link WR841N v7 编译的SDK文件名是<code>OpenWrt-SDK-ar71xx-for-linux-x86_64-gcc-4.8-linaro_uClibc-0.9.33.2.tar.bz2</code></li>
<li>（可选）OpenWrt-ImageBuilder-**.tar.bz2: 这个可以简单打包自己需要的Package和配置文件进入固件中。我的文件名为<code>OpenWrt-ImageBuilder-ar71xx_generic-for-linux-x86_64.tar.bz2</code></li>
<li>（可选）OpenWrt-Toolchain-**.tar.bz2: 这个是交叉编译工具链。我的是<code>OpenWrt-Toolchain-ar71xx-for-mips_34kc-gcc-4.8-linaro_uClibc-0.9.33.2.tar.bz2</code></li>
<li>md5sums 文件: 这个文件记录了所有我们编译好的文件的MD5值，来保证文件的完整性。</li>
</ol>
<p>编译完成后，一定要将<strong>编译好的bin目录进行备份</strong></p>
<h2 id="u6E05_u7406_u4EE5_u53CA_u518D_u7F16_u8BD1"><a href="#u6E05_u7406_u4EE5_u53CA_u518D_u7F16_u8BD1" class="headerlink" title="清理以及再编译"></a>清理以及再编译</h2><p>建议现在清理编译产生的文件，以免下次编译时造成冲突，也就是每次编译完成之后把需要的东西复制到别处，然后立即清理（因为要生成的文件如果存在的话，可能不会被替换），执行<code>make clean</code>  </p>
<p>注意：在执行clean命令，确保已经将编译好的Image进行了备份。清理工作会清除bin目录。</p>
<pre><code>$ make clean
</code></pre><p>除了清除生成的目录，还想清除交叉编译工具（以及工具链目录）</p>
<pre><code>$ make dirclean
</code></pre><p>清除所有相关的东西，包括下载的软件包，配置文件，feed内容等（不建议使用）</p>
<pre><code>$ make distclean
</code></pre><p>对于更新feeds后出现的错误：ERROR:please fix package/feeds/packages/mc/Makefile 等类似的问题，需要执行这条语句进行系统的清理</p>
<p>对于清理组件，比如软件包的清理</p>
<p>比如清理 linux</p>
<pre><code>$ make target/linux/clean
</code></pre><p>清理 base-files 软件包</p>
<pre><code>$ make package/base-files/clean
</code></pre><p>清理 Luci</p>
<pre><code>$ make package/luci/clean
</code></pre><h2 id="u548C_u5B98_u65B9_u4ED3_u5E93_u4FDD_u6301_u540C_u6B65"><a href="#u548C_u5B98_u65B9_u4ED3_u5E93_u4FDD_u6301_u540C_u6B65" class="headerlink" title="和官方仓库保持同步"></a>和官方仓库保持同步</h2><p>很多时候，我们在自己的某个Repository里面进行修改或者开发操作，所以要保证我们的代码与官方的代码保持同步。</p>
<p>官方仓库的地址是 <code>git://git.openwrt.org/openwrt.git</code> 或者 <code>http://git.openwrt.org/openwrt.git</code>。其他在GitHub上的仓库貌似都是镜像，比如<a href="https://github.com/openwrt-es/openwrt" target="_blank" rel="external">openwrt-es</a>以及<a href="https://github.com/openwrt-mirror/openwrt" target="_blank" rel="external">openwrt-mirror</a>。</p>
<p>如果还没进行过多少修改的代码，可以直接fork给出的repo，然后可以方便的使用github本身看我们的分支和官方的代码有多少的超前和滞后提交，可以作为一个提醒。</p>
<p>接下来，我们建立一个远程仓库名为<code>upstream</code>：</p>
<pre><code>$ git remote -v   // 首先列出远程仓库，一般只有一个origin

$ git remote add upstream http://git.openwrt.org/openwrt.git
</code></pre><p>这样就建立好了，我们可以接着列出远程仓库看一下.如果需要变更或者删除远程仓库的话，请参考git remote的manpage.</p>
<p>有的人喜欢使用<code>git pull</code>，但是官方推荐的是使用fetch然后merge，这样有什么区别还有冲突都一目了然.</p>
<pre><code>$ git fetch upstream master   // 从官方拉下来最新代码，一般只取得master就行了，其他分支根据需求选择

$ git checkout master   // 切换到主分支，或者是切换到你需要merge到的分支

$ git merge upstream/master // 自动merge进上面切换到的分支中，可以自动或者手动解决冲突
</code></pre><p>这种方法进行的是三方合并，每次都会产生一个合并的commit，看一下git log顿时瞎眼，对于强迫症而言怎么能忍？</p>
<p>另外一种单线git log的方式，适用于各种强迫症患者：</p>
<p>既然是单线方式，最有可能的也就是<code>git-rebase</code>了，基本思路是本地建立一个upstream分支，跟踪上游的变化，只使用<code>git-fetch</code>拉取上游，定期在本地master上进行rebase.</p>
<pre><code>$ git fetch upstream master  // 继续拉取上游最新commit

$ git checkout -b upstream upstream/master  //以 upstream/master 为分界点取出一个名为upstream的分支

$ git checkout master // 切换到主分支

$ git rebase -i upstream // 将 upstream 分支rebase进本地的主分支

$ git branch -d upstream // 最后可以删除upstream分支，如果没有完全rebase进来的话是不会让你删除这个分支的
</code></pre><p>当然git-rebase我也用不好，如果发现方法不对或者有更好办法欢迎PR</p>
<p>这样，我们就能时刻和官方保持一致了.</p>
<h2 id="OpenWRT__u7F16_u8BD1_doc__u6587_u4EF6"><a href="#OpenWRT__u7F16_u8BD1_doc__u6587_u4EF6" class="headerlink" title="OpenWRT 编译 doc 文件"></a>OpenWRT 编译 doc 文件</h2><p>在 OpenWrt 的 trunk 分支中有一个文件夹名为 <code>doc</code>，在这个文件夹中包含一部分文档可供参考，是用 LaTeX 写的，我们需要编译之后才能阅读的更顺畅，编译之后默认生成 .pdf 和 .htm 文件。</p>
<p>在 Ubuntu 我们可以使用 apt-get 从网络上直接下载包来安装。</p>
<p>我们用到的三个比较重要的命令有 <code>apt-cache search</code> 、<code>apt-cache show</code> 和 <code>sudo apt-get install</code> </p>
<p>首先使用</p>
<pre><code>$ apt-cache search latex
</code></pre><p>我们可以看到许多包被列出。选择安装<code>texlive-latex-base</code>, 它的描述是：Tex Live: Basic LaTex packages</p>
<pre><code>sudo apt-get install texlive-latex-base
</code></pre><p>这样就安装好Latex了，可以直接使用。 但编译中文时，由于没有安装CJK中文环境，会提示找不到CJK包。</p>
<pre><code>$ apt-cache search cjk
</code></pre><p>选择安装<code>latex-cjk-all</code>, 它的描述是：Installs all LaTex CJK packages.</p>
<pre><code>sudo apt-get install latex-cjk-all 
</code></pre><p>这样就可以使用中文环境了。 </p>
<p>有些.sty文件可能没有安装，例如：lastpage.sty. 这个时候不要到网络上去询问是因为什么， Latex的输出错误信息已经很明显了。<br>使用下面的命令来查找相应的包。  <strong>注意不要加.sty文件后缀</strong></p>
<pre><code>$ apt-cache search lastpage
</code></pre><p>可以看到需要下面的包，以及对这个包的描述：texlive-latex-extra - TeX Live: LaTeX supplementary packages  选择安装即可：</p>
<pre><code>sudo apt-get install texlive-latex-extra
</code></pre><p>完成上面的这三步，就可以基本满足平时的应用需求了。如果以后需要使用新的包，可以使用上面的方法来查找相应的安装包，并选择安装即可。</p>
<h2 id="u589E_u52A0_u8BBE_u5907_u652F_u6301"><a href="#u589E_u52A0_u8BBE_u5907_u652F_u6301" class="headerlink" title="增加设备支持"></a>增加设备支持</h2><h5 id="u524D_u63D0"><a href="#u524D_u63D0" class="headerlink" title="前提"></a>前提</h5><p>如果是专业搞过嵌入式开发的，懂得架构以及其他必要知识的可以忽略这个前提，接下来就是我要说的了，找一款和你想要添加的设备<strong>很相近</strong>且官方已经有了支持的型号，至少要是相同的平台，比如ar71xx.这部分基本上围绕这个前提来展开。</p>
<h5 id="u6240_u9700"><a href="#u6240_u9700" class="headerlink" title="所需"></a>所需</h5><p>完整 OpenWrt 开发环境. 包括编辑器, 配置好的 <code>quilt</code> 工具.</p>
<p>假设之前已经编译过 bin, 有<strong>完整的 .config 和 toolchain</strong>.</p>
<p>目前看到的很多教程教人直接修改现有的 patch 文件或者是 tmp/ 文件夹下的文件，更甚者胡乱猜测，这样会导致一些问题。</p>
<p>比如源码更新的时候，许多 Patch 文件的偏移（offset）会发生变更，主要体现在 linux 内核版本升级的时候，这样直接修改现成的 Patch 就会增添许多烦恼，其实官方有一个很好的东东，那就是这个 quilt，它是用来管理代码树中的 patch 的嵌入式内核开发利器!</p>
<h5 id="u589E_u52A0_Device-Specific__u652F_u6301_u6587_u4EF6"><a href="#u589E_u52A0_Device-Specific__u652F_u6301_u6587_u4EF6" class="headerlink" title="增加 Device-Specific 支持文件"></a>增加 Device-Specific 支持文件</h5><p>这个部分的文件是单独的，与其他的文件比如各种 Patch 没有较大的关联，在重新编译之前只需要<code>make clean</code>就行。</p>
<p>我们以添加 TP-Link TL-WR2041N v1 版本为例子进行说明：</p>
<p>新手刚开始添加支持的时候最好在取出最新的 trunk 代码之后立即进行，防止其他文件干扰，如果之前做过类似的操作或者懂得目录结构、知道文件是做什么用的，可以忽略这个建议。</p>
<p><strong>删除 tmp/ 目录</strong>，这个是大坑，因为这个文件夹内的内容全是生成的，没必要进行更改。</p>
<pre><code>$ rm -rvf tmp/
</code></pre><p>首先，如同前文所述，确定好相近的型号，方便添加支持。我这个型号的板子与国外的 WDR3500 相似，与国内的 TP-Link TL-WR941N v6 相同，我是通过 WDR3500 进行添加的。</p>
<p>搜索以下相关的文件，以确定需要修改什么文件，之后照猫画虎。</p>
<p>运行 <code>grep wdr3500 trunk/* -r -l</code> 得到的结果如下，我已经做好了分类：</p>
<pre><code>// 这部分是Device-Specific的
trunk/target/linux/ar71xx/base-files/etc/diag.sh
trunk/target/linux/ar71xx/base-files/etc/uci-defaults/01_leds
trunk/target/linux/ar71xx/base-files/etc/uci-defaults/02_network
trunk/target/linux/ar71xx/base-files/lib/upgrade/platform.sh
trunk/target/linux/ar71xx/base-files/lib/ar71xx.sh
trunk/target/linux/ar71xx/files/arch/mips/ath79/mach-tl-wdr3500.c
// 这部分是制作镜像的相关文件
trunk/target/linux/ar71xx/image/Makefile
trunk/target/linux/ar71xx/generic/profiles/tp-link.mk
trunk/tools/firmware-utils/src/mktplinkfw.c
// 这部分是内核支持相关的文件
trunk/target/linux/ar71xx/config-3.10
trunk/target/linux/ar71xx/patches-3.10/610-MIPS-ath79-openwrt-machines.patch
</code></pre><p>得到的文件就是基本的支持文件了，我们一个一个说。</p>
<h5 id="diag-sh"><a href="#diag-sh" class="headerlink" title="diag.sh"></a>diag.sh</h5><p>这个文件是 openwrt 初始化时闪烁的灯的配置，一般的路由启动的时候只闪烁 System 灯或者电源灯，基本没有修改的价值，仿照修改即可。</p>
<p>比如2041n v1：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">tl-wdr3500 | \</span><br><span class="line">tl-wr2041n-v1 | \</span><br><span class="line">........</span><br><span class="line">tl-wr941nd)</span><br><span class="line">	status_led=<span class="string">"tp-link:green:system"</span></span><br></pre></td></tr></table></figure></p>
<p>添加到该位置就行。</p>
<h5 id="uci-defaults/01_leds"><a href="#uci-defaults/01_leds" class="headerlink" title="uci-defaults/01_leds"></a>uci-defaults/01_leds</h5><p>这个文件是定义 led 的信息的，简单的比如 <code>ucidef_set_led_netdev</code> 多用于定义 WAN 口，修改最后的 eth0 为你对应的设备名称； <code>ucidef_set_led_wlan</code> 多用于定义 WLAN 口，最后的 <code>phyxtpt</code> 目前见到的只有 x=0 和1两种情况，这个和设备初始出来的phy物理设备相关； <code>ucidef_set_led_switch</code> 用来定义交换机的配置，最后的 0x00 部分是端口掩码，一般的顺序如下。</p>
<p>至于更详细的定义过程，需要参考 <code>packages/base-files/files/lib/functions</code> 目录的 <code>uci-defaults.sh</code> 脚本。（目前新加的文件 <code>uci-defaults-new.sh</code> 文件，看样子是通过 JSON 传值的，应该是应用于新的设备或者新的架构的）</p>
<p>比如2041n v1：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">tl-wr2041n-v1)</span><br><span class="line">	ucidef_<span class="built_in">set</span>_led_netdev <span class="string">"wan"</span> <span class="string">"WAN"</span> <span class="string">"tp-link:green:wan"</span> <span class="string">"eth0"</span></span><br><span class="line">	ucidef_<span class="built_in">set</span>_led_switch <span class="string">"lan1"</span> <span class="string">"LAN1"</span> <span class="string">"tp-link:green:lan1"</span> <span class="string">"switch0"</span> <span class="string">"0x02"</span></span><br><span class="line">	ucidef_<span class="built_in">set</span>_led_switch <span class="string">"lan2"</span> <span class="string">"LAN2"</span> <span class="string">"tp-link:green:lan2"</span> <span class="string">"switch0"</span> <span class="string">"0x04"</span></span><br><span class="line">	ucidef_<span class="built_in">set</span>_led_switch <span class="string">"lan3"</span> <span class="string">"LAN3"</span> <span class="string">"tp-link:green:lan3"</span> <span class="string">"switch0"</span> <span class="string">"0x08"</span></span><br><span class="line">	ucidef_<span class="built_in">set</span>_led_switch <span class="string">"lan4"</span> <span class="string">"LAN4"</span> <span class="string">"tp-link:green:lan4"</span> <span class="string">"switch0"</span> <span class="string">"0x10"</span></span><br><span class="line">	ucidef_<span class="built_in">set</span>_led_netdev <span class="string">"wlan"</span> <span class="string">"WLAN"</span> <span class="string">"tp-link:green:wlan"</span> <span class="string">"wlan0"</span></span><br><span class="line">	ucidef_<span class="built_in">set</span>_led_wlan <span class="string">"wlan"</span> <span class="string">"WLAN"</span> <span class="string">"tp-link:green:wlan"</span> <span class="string">"phy1tpt"</span></span><br><span class="line">	;;</span><br></pre></td></tr></table></figure></p>
<h5 id="uci-defaults/02_network"><a href="#uci-defaults/02_network" class="headerlink" title="uci-defaults/02_network"></a>uci-defaults/02_network</h5><p>该文件定义初始化网络信息，主要是交换机和 vlan，<del>不过我遇到怪异的事情是，<code>ucidef_set_interfaces_lan_wan</code> 紧跟着的第一个参数是定义 wan 的，第二个是定义 lan 的，比如下面的 eth0 是 wan 而 eth1 是 lan 。</del>（貌似是在设备 mach 文件中定义的问题，看了一下网络初始化的脚本 <code>uci-defaults.sh</code> 中的定义，应该第一个参数是 lan ,第二个是 wan）<br>比如 wr2041n v1：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">tl-wr2041n-v1)</span><br><span class="line">	ucidef_<span class="built_in">set</span>_interfaces_lan_wan <span class="string">"eth0"</span> <span class="string">"eth1"</span></span><br><span class="line">	ucidef_add_switch <span class="string">"switch0"</span> <span class="string">"1"</span> <span class="string">"1"</span></span><br><span class="line">	ucidef_add_switch_vlan <span class="string">"switch0"</span> <span class="string">"1"</span> <span class="string">"0 1 2 3 4"</span></span><br><span class="line">	;;</span><br></pre></td></tr></table></figure></p>
<h5 id="uci-defaults_u7684_u8BF4_u660E"><a href="#uci-defaults_u7684_u8BF4_u660E" class="headerlink" title="uci-defaults的说明"></a>uci-defaults的说明</h5><p>从 <a href="https://github.com/openwrt/openwrt/commit/dd300dc979eb65b189656b34e8b2cfaeba0f6afb" target="_blank" rel="external">https://github.com/openwrt/openwrt/commit/dd300dc979eb65b189656b34e8b2cfaeba0f6afb</a> 以及之前的一些commit来看，官方使用原来的 uci-defaults-new.sh代替了uci-defaults.sh，主要影响的应该就是02_network的添加了，而且目前是统一放在 <code>/etc/board.d</code>里作为原来的<code>/etc/uci-defaults</code>. 对于switch部分，基本构成是”数字|@或者:|数字”，用”@”的应该是cpu port和switch口相连的，用”:”的应该是写vlan的，写在最前面的数字（@和:前）是对应设备lan wan插口，书写顺序可能是按照switch端口从0开始递增，先写lan部分再写wan部分。官方目前还没写注释，新写法依然存在困惑。<br>对于 wr2041n v1：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">tl-wr2041n-v1)</span><br><span class="line">	ucidef_<span class="built_in">set</span>_interfaces_lan_wan <span class="string">"eth0"</span> <span class="string">"eth1"</span></span><br><span class="line">	ucidef_add_switch <span class="string">"switch0"</span> \</span><br><span class="line">		<span class="string">"0@eth0"</span> <span class="string">"1:lan:4"</span> <span class="string">"2:lan:3"</span> <span class="string">"3:lan:2"</span> <span class="string">"4:lan:1"</span></span><br><span class="line">	;;</span><br></pre></td></tr></table></figure></p>
<h5 id="lib/upgrade/platform-sh"><a href="#lib/upgrade/platform-sh" class="headerlink" title="lib/upgrade/platform.sh"></a>lib/upgrade/platform.sh</h5><p>该文件是定义系统更新时验证的，基本上不用怎么更改。</p>
<p>比如 2041n v1：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tl-wdr3500 | \</span><br><span class="line">tl-wr2041n-v1 | \</span><br></pre></td></tr></table></figure></p>
<p>添加到了wdr3500的下方。</p>
<h5 id="lib/ar71xx-sh"><a href="#lib/ar71xx-sh" class="headerlink" title="lib/ar71xx.sh"></a>lib/ar71xx.sh</h5><p>第一个是硬件 magic number，可以用 WinHex 打开固件文件，查看对应的偏移即可找到，model 定义的是显示的设备名称，下面的 <code>*&quot;TL-WR2041N v1&quot;</code> 要对应设备支持的 mach C语言设备文件中定义好的名称；同样的， name 定义的是内部传递的值，最好与上面添加的行一致。简单来说，涉及到型号名称的最好都保持一致。</p>
<p>比如 2041n v1：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">       <span class="string">"204100"</span>*)</span><br><span class="line">	model=<span class="string">"TP-Link TL-WR2041N"</span></span><br><span class="line">	;;</span><br><span class="line"></span><br><span class="line">*<span class="string">"TL-WR2041N v1"</span>)</span><br><span class="line">	name=<span class="string">"tl-wr2041n-v1"</span></span><br><span class="line">	;;</span><br></pre></td></tr></table></figure></p>
<h5 id="files/arch/mips/ath79/mach-tl-wdr3500-c"><a href="#files/arch/mips/ath79/mach-tl-wdr3500-c" class="headerlink" title="files/arch/mips/ath79/mach-tl-wdr3500.c"></a>files/arch/mips/ath79/mach-tl-wdr3500.c</h5><p>这个就是很重要的设备支持 C语言文件了，开头的前缀 mach 最好保留，mach后的名称需要与以后添加的linux patch支持名称保持一致。</p>
<p>一般用于定义 led、flash 以及 PHY4 等等涉及到的端口信息，有的mach文件还涉及到 ART 的偏移量（offset），ART是存储无线数据的分区，如果设置不当会导致路由没有无线。</p>
<p>为了最快的添加路由支持，可以采用sed, awk工具批量改名的方法，写出一个设备支持文件来，当然也可以使用 vim, emacs批量完成。</p>
<p>比如 2041n v1：<br>新建文件 target/linux/ar71xx/files/arch/mips/ath79/mach-tl-wr2041n-v1.c，详情请<a href="https://github.com/wongsyrone/openwrt-1/blob/master/target/linux/ar71xx/files/arch/mips/ath79/mach-tl-wr2041n-v1.c" target="_blank" rel="external">戳这里</a></p>
<p>值得注意的是：<br><code>MIPS_MACHINE(ATH79_MACH_TL_WR2041N_V1, &quot;TL-WR2041N-v1&quot;, &quot;TP-LINK TL-WR2041N v1&quot;, wr2041n_setup);</code><br>第一部分要与 <code>config-3.10</code> 文件中添加的内容以及后面添加的linux kernel patch中的内容一致；<code>&quot;TL-WR2041N-v1&quot;</code> 是定义的设备名称，最好与 image 的 Makefile一致；”TP-LINK TL-WR2041N v1” 与前面涉及到的 <code>lib/ar71xx.sh</code> 文件相关；最后的 <code>wr2041n_setup</code> 是设备初始化的主函数名称。</p>
<h4 id="u955C_u50CF_u751F_u6210_u7684_u76F8_u5173_u6587_u4EF6"><a href="#u955C_u50CF_u751F_u6210_u7684_u76F8_u5173_u6587_u4EF6" class="headerlink" title="镜像生成的相关文件"></a>镜像生成的相关文件</h4><h5 id="trunk/target/linux/ar71xx/image/Makefile"><a href="#trunk/target/linux/ar71xx/image/Makefile" class="headerlink" title="trunk/target/linux/ar71xx/image/Makefile"></a>trunk/target/linux/ar71xx/image/Makefile</h5><p>该文件主要修改如下两行，剩下的内容需要仔细学习 Makefile的写法才能看懂。</p>
<pre><code>$(eval $(call MultiProfile,TLWR2041,TLWR2041NV1))
</code></pre><p>该行定义多Profile，一般是一个型号生成多个硬件版本支持的定义</p>
<pre><code>$(eval $(call SingleProfile,TPLINK-LZMA,64kraw,TLWR2041NV1,tl-wr2041n-v1,TL-WR2041N-v1,ttyS0,115200,0x20410001,1,4Mlzma))
</code></pre><p>该行是单独设备的支持信息，第一个参数是使用什么生成办法，2041n v1是使用 <code>TPLINK-LZMA</code> 方法，前面有对应的说明，从里面也可以看到我们需要修改 bin/mktplinkfw 文件的源代码，该源代码在 <code>trunk/tools/firmware-utils/src/mktplinkfw.c</code> 中 接下来可以根据对 TPLINK-LZMA 的定义看到依次传进去的参数，TLWR2041NV1 是 Profile 名称，tl-wr2041n-v1 是生成的镜像名称，也（可能）是传进去的设备型号，TL-WR2041N-v1 最好对应前面 mach 文件 MIPS_MACHINE 函数的信息，主要是在内核日志和系统日志中体现设备型号，后面的是默认 tty 信息以及 baudrate 波特率，接下来的 magic number是设备的硬件ID，1 是版本，一般不用变，4Mlzma是生成固件的layout信息，该值和硬件ID都在 mktplinkfw.c 中定义。</p>
<h5 id="trunk/target/linux/ar71xx/generic/profiles/tp-link-mk"><a href="#trunk/target/linux/ar71xx/generic/profiles/tp-link-mk" class="headerlink" title="trunk/target/linux/ar71xx/generic/profiles/tp-link.mk"></a>trunk/target/linux/ar71xx/generic/profiles/tp-link.mk</h5><p>该文件定义 Profile 信息，主要定义 NAME，会显示在 <code>make menuconfig</code> 之后的设备选项里； PACKAGES 定义默认编译安装的包，一般是网卡驱动以及其他必备的包，如 usb支持。</p>
<p>比如 2041n v1：<br><figure class="highlight mk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">define Profile/TLWR2041</span><br><span class="line">	NAME:=TP-LINK TL-WR2041N</span><br><span class="line">	PACKAGES:=</span><br><span class="line">endef</span><br><span class="line"></span><br><span class="line">define Profile/TLWR2041/Description</span><br><span class="line">	Package set optimized for the TP-LINK TL-WR2041N.</span><br><span class="line">endef</span><br><span class="line">$(eval $(call Profile,TLWR2041))</span><br></pre></td></tr></table></figure></p>
<h5 id="trunk/tools/firmware-utils/src/mktplinkfw-c"><a href="#trunk/tools/firmware-utils/src/mktplinkfw-c" class="headerlink" title="trunk/tools/firmware-utils/src/mktplinkfw.c"></a>trunk/tools/firmware-utils/src/mktplinkfw.c</h5><p>该文件是生成固件文件的工具，里面包含 TP-LINK 固件 bin 文件的结构和 md5 hash 验证算法，比如定义硬件 magic number，flash layout， 以及其他信息。</p>
<p>比如 2041n v1：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">define</span> HWID_TL_WR2041N_V1	<span class="number">0x20410001</span>   <span class="comment">//定义硬件ID</span></span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">		.id		= <span class="string">"TL-WR2041Nv1"</span>,</span><br><span class="line">		.hw_id		= HWID_TL_WR2041N_V1,</span><br><span class="line">		.hw_rev		= <span class="number">1</span>,</span><br><span class="line">		.layout_id	= <span class="string">"4Mlzma"</span>,</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure></p>
<p>定义使用的信息。</p>
<h5 id="config-3-10"><a href="#config-3-10" class="headerlink" title="config-3.10"></a>config-3.10</h5><p>添加内核支持的 config 信息，与其他的保持一致就好。</p>
<p>比如 2041n v1：</p>
<pre><code>CONFIG_ATH79_MACH_TL_WR2041N_V1=y
</code></pre><p>CONFIG_ 后面的内容和上面 mach 硬件支持文件中定义的保持一致。</p>
<h5 id="patches-3-10/610-MIPS-ath79-openwrt-machines-patch"><a href="#patches-3-10/610-MIPS-ath79-openwrt-machines-patch" class="headerlink" title="patches-3.10/610-MIPS-ath79-openwrt-machines.patch"></a>patches-3.10/610-MIPS-ath79-openwrt-machines.patch</h5><p>这个是内核支持的patch文件，需要使用 quilt 创建以及以后维护，前一阵子trunk将大部分分散的补丁都移动到这个patch中了，如果要将patch提交到官方尽量放在这里，自己用的话不要干扰其他patch的应用就可以了。我这里将补丁编号为920，一般来说是最后一个应用的patch了。</p>
<h4 id="u7BA1_u7406_u8865_u4E01_u6587_u4EF6"><a href="#u7BA1_u7406_u8865_u4E01_u6587_u4EF6" class="headerlink" title="管理补丁文件"></a>管理补丁文件</h4><p>请通过软件包管理器安装 quilt，当然一般如同上文配置好编译环境就已经安装好了 quilt。</p>
<p>然后写入以下配置文件到 <code>~/.quiltrc</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; ~/.quiltrc &lt;&lt;EOF</span><br><span class="line">QUILT_DIFF_ARGS=<span class="string">"--no-timestamps --no-index -pab --color=auto"</span></span><br><span class="line">QUILT_REFRESH_ARGS=<span class="string">"--no-timestamps --no-index -pab"</span></span><br><span class="line">QUILT_PATCH_OPTS=<span class="string">"--unified"</span></span><br><span class="line">QUILT_DIFF_OPTS=<span class="string">"-p"</span></span><br><span class="line">EDITOR=<span class="string">"nano"</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p>接着进行一下 <code>export EDITOR</code> ，当然这个 <code>EDITOR</code> 的变量不要和现有的变量冲突，可以自己任意更改，只要应用到上面的 <code>.quiltrc</code> 文件中就好了。如果怕麻烦可以写到 <code>～/.bashrc</code> 文件中，以后就比较方便，不用每次进行 export。</p>
<p>常用的quilt命令如下，会一一说明: </p>
<pre><code>new        新建空白patch
add        添加要修改的文件到patch中
remove        删除patch
top        查看当前patch位置，相当于一个指针
next        未知
rename        重命名patch
unapplied    查看未成功应用的patch
applied        查看已经成功应用的patch
graph        未知
patches        未知
upgrade        未知
delete        删除patch
grep        应该类似于 grep 命令
pop        去往上一个patch，如果附加patch名称则按照patch序列一直应用到特定的patch位置
series        查看patch列表，一般这个顺序就是patch应用的顺序，可以用来进行 pop 和 push 定位
diff        查看区别
previous    未知
edit        编辑当前patch中的文件
push        去往最新的patch，会一直应用到最后一个可以成功应用的patch
files        查看patch中包含的修改文件
refresh        刷新patch，相当于保存patch到 patches 文件夹，还没有应用到buildroot处
</code></pre><h4 id="u51E0_u79CD_u7BA1_u7406_u64CD_u4F5C"><a href="#u51E0_u79CD_u7BA1_u7406_u64CD_u4F5C" class="headerlink" title="几种管理操作"></a>几种管理操作</h4><h5 id="u589E_u52A0_u4E00_u4E2A_u65B0_u7684Patch"><a href="#u589E_u52A0_u4E00_u4E2A_u65B0_u7684Patch" class="headerlink" title="增加一个新的Patch"></a>增加一个新的Patch</h5><p>为一个现有的软件包添加一个新的 Patch 需要首先准备代码树：</p>
<pre><code>$ make package/example/{clean,prepare} V=s QUILT=1
</code></pre><p>如果是 host-side 的软件包需要进行下面的代码树准备操作：</p>
<pre><code>$ make package/example/host/{clean,prepare} V=s QUILT=1
</code></pre><p>这个步骤将解压源码包的 tarball 并且按照预先排好的 quilt patch 顺序进行准备工作（简单的讲，按照补丁文件前面的序号给 tarball 依次打好补丁），接下来会输出详细的打补丁情况，如果有未成功的会有 Hunk fail 字样；补丁应用成功的话也有两种情况，第一，行号偏移正常，这也就是我们期望的，第二，虽然应用成功了，但是存在代码行号偏移，出现的字样是 offset ，并且会提示补丁具体应用到了哪行，我们可以针对打补丁时给出的提示修改补丁文件的行号，也可以通过 quilt 修改.</p>
<p>接下来切换到代码目录中，值得注意的是，如果在 Makefile 中存在多个编译选项（build variants），需要切换到对应的代码目录中.</p>
<pre><code>$ cd build_dir/target-*/BUILD_VARIANT/example-*
</code></pre><p>接下来应用全部的已存在的补丁文件：</p>
<pre><code>$ quilt push -a
</code></pre><p>通过 <code>quilt new</code> 命令创建一个全新空白的补丁文件：</p>
<pre><code>$ quilt new 010-main_code_fix.patch
</code></pre><p>命名的时候需要注意的是，补丁文件的名字必须以数字开头，一般是三位，并且补足前面的零，数字之后紧跟一个短横线（-），接下来简单描述这个补丁文件是做什么用的，以便以后好查找；选定数字的时候，数字必须大于现有的最后一个 patch 的数字前缀，这个要求的原因可以通过 <code>quilt series</code> 来验证，排序的顺序就是补丁应用的顺序，而排序是通过前面的数字决定的；对补丁文件的描述要言简意赅，尽量用地道的英文术语.</p>
<p>创建好空白的补丁文件之后，必须要有修改的代码文件与之相关联，我们通过 <code>quilt add</code> 来进行这个操作，一旦添加好了文件，就像往常一样进行修改就可以了.<br>可以通过 <code>quilt edit</code> 命令来同时完成上面的关联文件操作以及修改操作，这个修改过程调用的文本编辑器是前面在 <code>.quiltrc</code> 文件里面定义好的 <code>EDITOR</code> 变量，注意export.</p>
<pre><code>$ quilt edit src/main.c  // 通过quilt的edit命令编辑代码文件
</code></pre><p>这样上面的代码文件就被加到这个新建的 patch 中了，这样一直重复操作，直到所有需要添加到该 patch 中的文件都修改完.</p>
<p>所有的修改操作都进行完之后，可以通过 <code>quilt diff</code> 命令查看修改的内容.</p>
<pre><code>$ quilt diff          // 很类似 git diff 不是吗
</code></pre><p>如果发现修改都处于预期，就可以把修改写入到刚才新建的patch文件中了，注意<strong>这时候的patch还在 build_dir 里面</strong>.</p>
<pre><code>$ quilt refresh
</code></pre><p>接下来切换到 buildroot 的顶层目录.</p>
<pre><code>$ cd ../../../      // 这个目录比修改 kernel 补丁时低了一层
</code></pre><p>接下来，我们将刚才新建的 patch 移动到 buildroot ，这样我们就可以将这个补丁进行提交等其他操作了.</p>
<pre><code>$ make package/example/update V=s
</code></pre><p>这样，我们的补丁添加工作就完成了，不放心的话可以通过下面的命令进行验证:</p>
<pre><code>$ make package/example/{clean,compile} package/index V=s
</code></pre><p>如果发现问题，需要重新进行编辑，下面介绍怎么编辑补丁文件.</p>
<h5 id="u7F16_u8F91_u4E00_u4E2A_u73B0_u6709_u7684patch"><a href="#u7F16_u8F91_u4E00_u4E2A_u73B0_u6709_u7684patch" class="headerlink" title="编辑一个现有的patch"></a>编辑一个现有的patch</h5><p>还是需要首先准备代码树:</p>
<pre><code>$ make package/example/{clean,prepare} V=s QUILT=1
</code></pre><p>接下来切换到代码目录中.</p>
<pre><code>$ cd build_dir/target-*/example-*
</code></pre><p>列出现有的所有patch文件：</p>
<pre><code>$ quilt series
</code></pre><p>前往需要编辑的patch文件，当然前提是这个push到的patch需要应用成功，否则需要push到提前一个patch或者push的时候加上 <code>-f</code> 参数强制运行，然后直接<code>quilt edit</code>即可，当然这个是后话.</p>
<pre><code>$ quilt push 010-main_code_fix.patch
</code></pre><p>当输入的patch文件名合法的话，<code>quilt push</code> 命令会只应用patch 系列（patch series）到给出的文件名，所以提前用 <code>quilt series</code> 命令看好文件名再操作，然后用 <code>quilt top</code> 命令看自己当前处于哪个patch中确保万无一失，如果不幸超过了所要去的补丁位置，可以通过 <code>quilt pop</code> 命令移除已经应用的补丁按照列表反向前进.</p>
<p>接下来通过 <code>quilt edit</code> 命令编辑每个需要编辑的文件.</p>
<pre><code>$ quilt edit src/main.c    // 熟悉的命令
</code></pre><p>接下来检查编辑的文件是否被包含在patch中了：</p>
<pre><code>$ quilt files
</code></pre><p>检查更改信息：</p>
<pre><code>$ quilt diff
</code></pre><p>如果发现修改都处于预期，就可以把修改写入patch文件中了，注意<strong>这时候的patch还在 build_dir 里面</strong>.</p>
<pre><code>$ quilt refresh
</code></pre><p>切换到buildroot的顶层目录中.</p>
<pre><code>$ cd ../../../
</code></pre><p>接下来，我们将刚才更新好的patch移动到buildroot中:</p>
<pre><code>$ make package/example/update V=s
</code></pre><p>这样，我们的补丁修改工作就完成了，不放心的话可以通过下面的命令进行验证:</p>
<pre><code>$ make package/example/{clean,compile} package/index V=s
</code></pre><h5 id="u65B0_u589E_u6216_u4FEE_u6539_u5185_u6838_u8865_u4E01"><a href="#u65B0_u589E_u6216_u4FEE_u6539_u5185_u6838_u8865_u4E01" class="headerlink" title="新增或修改内核补丁"></a>新增或修改内核补丁</h5><p>新增和修改内核补丁和操作安装包的补丁差不太多，只有 make 的 target 和操作代码目录是不同的.</p>
<p>特别需要注意的是，对于内核补丁，存在一个附加的子目录，一个是 generic/ 目录，这个里面包含对所有目标架构的补丁文件；另一个是 platform/ 目录，这里面包含特定架构的补丁文件，一般是在 <code>make menuconfig</code> 中配置好的架构，也可以在 <code>.config</code> 文件中找到.</p>
<p>准备内核代码树:</p>
<pre><code>$ make target/linux/{clean,prepare} V=s QUILT=1
</code></pre><p>对稳定版AA（Attitude Adjustment）来说，内核代码树在这里:</p>
<pre><code>$ cd build_dir/linux-*/linux-3.*
</code></pre><p>对主干分支，现在是BB（Barrier Breaker），代码树在这里：</p>
<pre><code>$ cd build_dir/target-*/linux-*/linux-3.*
</code></pre><p>我们将刚才操作好的patch移动到buildroot中通过下面的命令：</p>
<pre><code>$ make target/linux/update package/index V=s
</code></pre><p>注意：Patch文件的前缀必须正确，指明是 generic 还是 platform，如果前缀不正确，可能应用操作会出问题.</p>
<p>不放心的话可以通过下面的命令进行验证，首先去顶层目录，一般是 target/ 所在的目录：</p>
<pre><code>$ cd ../../../../
</code></pre><p>然后再次准备代码树，查看更改是否已经应用了：</p>
<pre><code>$ make target/linux/{clean,prepare} V=s QUILT=1
</code></pre><p>最后要说的是，放置patch的位置很重要，它决定补丁的应用情况.</p>
<h5 id="u589E_u52A0_u6216_u7F16_u8F91_u5DE5_u5177_u94FE_Patch_uFF08_u8FD9_u90E8_u5206_u4E00_u822C_u4E0D_u4F1A_u6D89_u53CA_uFF09"><a href="#u589E_u52A0_u6216_u7F16_u8F91_u5DE5_u5177_u94FE_Patch_uFF08_u8FD9_u90E8_u5206_u4E00_u822C_u4E0D_u4F1A_u6D89_u53CA_uFF09" class="headerlink" title="增加或编辑工具链 Patch（这部分一般不会涉及）"></a>增加或编辑工具链 Patch（这部分一般不会涉及）</h5><p>以 gcc 为例:</p>
<p>编译过toolchain或者是看toolchain目录的主Makefile可以发现gcc有三个编译阶段：initial, minimal和final，如果要修改gcc的patch，需要使用minimal那个阶段。</p>
<p>准备工具链代码树:</p>
<pre><code>$ make toolchain/gcc/minimal/{clean,prepare} V=99 QUILT=1
</code></pre><p>代码树路径取决于选择的库以及 gcc :</p>
<pre><code>$ cd build_dir/toolchain-mips_r2_gcc-4.3.3+cs_uClibc-0.9.30.1/gcc-linaro-&lt;version&gt;
</code></pre><p>通过如下命令更新Patch:</p>
<pre><code>$ make toolchain/gcc/minimal/update V=99
</code></pre><p>对于其余的binutils, gdb, glibc之类的由于没有细分阶段，所以直接按照软件包那样的格式套用就行了。</p>
<p>比如 <code>make toolchain/(gdb|glibc|binutils)/{clean,prepare} V=99 QUILT=1</code>, <code>make toolchain/(gdb|glibc|binutils)/update V=99</code></p>
<h5 id="u5237_u65B0Patch"><a href="#u5237_u65B0Patch" class="headerlink" title="刷新Patch"></a>刷新Patch</h5><p>当软件包更新或者内核更新时，现有的patch文件可能不会完全应用或者存在其他提示。想要重新构建Patch列表中的全部patch可以使用make目标：refresh.</p>
<pre><code>$ make package/example/refresh V=s    // 软件包
$ make target/linux/refresh V=s       // 内核
</code></pre><h5 id="u4E0D_u6E05_u7406_u4EE3_u7801_u6811_u91CD_u590D_u4FEE_u6539_u8865_u4E01"><a href="#u4E0D_u6E05_u7406_u4EE3_u7801_u6811_u91CD_u590D_u4FEE_u6539_u8865_u4E01" class="headerlink" title="不清理代码树重复修改补丁"></a>不清理代码树重复修改补丁</h5><p>当需要引入新功能做更改时，经常需要多次修改补丁。为了加速，可以在编辑操作（edit）之间保留做完准备操作的代码树.</p>
<ol>
<li>刚开始如上文所述准备好代码树;</li>
<li>切换到准备好的代码目录;</li>
<li>前往需要修改的patch位置;</li>
<li>修改文件并保存对patch文件的更改;</li>
<li>通过 <code>quilt push -a</code> 命令完全应用剩下的补丁文件;</li>
<li>切换到顶层目录运行 <code>make package/example/{compile,install}</code> ，如果是内核的补丁，使用 <code>make target/linux/{compile,install}</code> 命令;</li>
<li>测试二进制文件。如果再次需要进行更改，从第二步重复操作；</li>
<li>最后使用 <code>make package/example/update</code> 命令 ，如果是内核补丁，使用 <code>make target/linux/update</code> 命令将patch文件应用到buildroot中。</li>
</ol>
<h5 id="u51C6_u5907_linux__u5185_u6838_patch_uFF08_u65E7_uFF09"><a href="#u51C6_u5907_linux__u5185_u6838_patch_uFF08_u65E7_uFF09" class="headerlink" title="准备 linux 内核 patch（旧）"></a>准备 linux 内核 patch（旧）</h5><p>到这里基本就完成了 OpenWrt 的设备支持代码. 为了支持我们的设备, Linux 代码树的部分文件也需要做改动, OpenWrt 采用了 patch 的方式实现.</p>
<p>回退到源代码的根目录 <code>~/trunk</code> .</p>
<p>清理并准备 patch 树:</p>
<pre><code>$ make target/linux/{clean,prepare} V=s QUILT=1
</code></pre><p>进入内核代码目录:</p>
<pre><code>$ cd build_dir/target-*/linux-ar71xx_generic/linux-3.x/
</code></pre><p>这里就是内核代码树了, 里面的代码是已经打过所有 patch 的, 可以用 <code>quilt push</code> 检查看是不是这样:</p>
<pre><code>$ quilt push
</code></pre><blockquote>
<p>File series fully applied, ends at patch platform/xxx-xxxxxxxxxxxxxx.patch.</p>
</blockquote>
<p>这条输出也告诉我们, 当前最顶的 patch 是 platform/xxx</p>
<p>为我的 WL-WR2041N v1 新建个 patch:</p>
<pre><code>$ quilt new platform/920-MIPS-ath79-add-TL-WR2041N-v1-support.patch
</code></pre><p>选择的数字需要大于刚才的那个 xxx , 然后 quilt 会自动把这个 patch 设置为当前 patch, 所有的改动都针对这个 patch.</p>
<p>注意修改文件之前一定要看自己位于哪个patch下，否则修改都会更新到那个patch.</p>
<p>然后就是增加代码了</p>
<pre><code>$ quilt edit arch/mips/ath79/Kconfig
$ quilt edit arch/mips/ath79/Makefile
$ quilt edit arch/mips/ath79/machtypes.h
</code></pre><p>至于怎么改, 参考这些文件里其他硬件的配置</p>
<p>比如 2041n v1:<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">--- a/arch/mips/ath79/Kconfig</span><br><span class="line">+++ b/arch/mips/ath79/Kconfig</span><br><span class="line">@@ -<span class="number">900</span>,<span class="number">6</span> +<span class="number">900</span>,<span class="number">16</span> @@ config ATH79_MACH_TL_WR1043ND_V2</span><br><span class="line"> 	select ATH79_DEV_USB</span><br><span class="line"> 	select ATH79_DEV_WMAC</span><br><span class="line"> </span><br><span class="line">+config ATH79_MACH_TL_WR2041N_V1</span><br><span class="line">+	bool <span class="string">"TP-LINK TL-WR2041N v1 board support"</span></span><br><span class="line">+	select SOC_AR934X</span><br><span class="line">+	select ATH79_DEV_AP9X_PCI <span class="keyword">if</span> PCI</span><br><span class="line">+	select ATH79_DEV_ETH</span><br><span class="line">+	select ATH79_DEV_GPIO_BUTTONS</span><br><span class="line">+	select ATH79_DEV_LEDS_GPIO</span><br><span class="line">+	select ATH79_DEV_M25P80</span><br><span class="line">+ 	select ATH79_DEV_WMAC</span><br><span class="line">+</span><br><span class="line"> config ATH79_MACH_TL_WR2543N</span><br><span class="line"> 	bool <span class="string">"TP-LINK TL-WR2543N/ND support"</span></span><br><span class="line"> 	select SOC_AR724X</span><br><span class="line">--- a/arch/mips/ath79/Makefile</span><br><span class="line">+++ b/arch/mips/ath79/Makefile</span><br><span class="line">@@ -<span class="number">116</span>,<span class="number">6</span> +<span class="number">116</span>,<span class="number">7</span> @@ obj-$(CONFIG_ATH79_MACH_TL_WR841N_V9)	+=</span><br><span class="line"> obj-$(CONFIG_ATH79_MACH_TL_WR941ND)	+= mach-tl-wr941nd.o</span><br><span class="line"> obj-$(CONFIG_ATH79_MACH_TL_WR1041N_V2)	+= mach-tl-wr1041n-v2.o</span><br><span class="line"> obj-$(CONFIG_ATH79_MACH_TL_WR1043ND)	+= mach-tl-wr1043nd.o</span><br><span class="line">+obj-$(CONFIG_ATH79_MACH_TL_WR2041N_V1)	+= mach-tl-wr2041n-v1.o</span><br><span class="line"> obj-$(CONFIG_ATH79_MACH_TL_WR1043ND_V2)	+= mach-tl-wr1043nd-v2.o</span><br><span class="line"> obj-$(CONFIG_ATH79_MACH_TL_WR2543N)	+= mach-tl-wr2543n.o</span><br><span class="line"> obj-$(CONFIG_ATH79_MACH_TL_WR703N)	+= mach-tl-wr703n.o</span><br><span class="line">--- a/arch/mips/ath79/machtypes.h</span><br><span class="line">+++ b/arch/mips/ath79/machtypes.h</span><br><span class="line">@@ -<span class="number">134</span>,<span class="number">6</span> +<span class="number">134</span>,<span class="number">7</span> @@ enum ath79_mach_<span class="built_in">type</span> &#123;</span><br><span class="line"> 	ATH79_MACH_TL_WR1041N_V2,	/* TP-LINK TL-WR1041N v2 */</span><br><span class="line"> 	ATH79_MACH_TL_WR1043ND,		/* TP-LINK TL-WR1043ND */</span><br><span class="line"> 	ATH79_MACH_TL_WR1043ND_V2,	/* TP-LINK TL-WR1043ND v2 */</span><br><span class="line">+	ATH79_MACH_TL_WR2041N_V1,       /* TP-LINK TL-WR2041N v1 */</span><br><span class="line"> 	ATH79_MACH_TL_WR2543N,		/* TP-LINK TL-WR2543N/ND */</span><br><span class="line"> 	ATH79_MACH_TL_WR703N,		/* TP-LINK TL-WR703N */</span><br><span class="line"> 	ATH79_MACH_TL_WR710N,		/* TP-LINK TL-WR710N */</span><br></pre></td></tr></table></figure></p>
<p>仅作为参考。</p>
<p>然后验证下修改的内容:</p>
<pre><code>$ quilt diff # 查看 diff
$ quilt refresh # 保存所有 diff 到 patch 文件
</code></pre><p>这个时候我们的 patch 文件还在 build_dir 里, 大概位置是 <code>patches/platform/</code> 下. 需要同步到 OpenWrt 代码树.</p>
<p>退回到顶层工作目录, 执行:</p>
<pre><code>$ make target/linux/update V=s
</code></pre><p>同步完成后, patch 文件会出现在 <code>target/linux/ar71xx/patches-3.x/</code> 下.</p>
<p>以后代码更新后需要编辑 patch 时，遵从上面的 quilt 对 patch 的管理操作。</p>
<h5 id="u51C6_u5907_linux__u5185_u6838_u677F_u7EA7_u652F_u6301_uFF08_u65B0_uFF09"><a href="#u51C6_u5907_linux__u5185_u6838_u677F_u7EA7_u652F_u6301_uFF08_u65B0_uFF09" class="headerlink" title="准备 linux 内核板级支持（新）"></a>准备 linux 内核板级支持（新）</h5><p>从 <a href="https://github.com/openwrt/openwrt/commit/1e82d9f741cd827e33bfa3d8b3cadffaeb2773c1" target="_blank" rel="external">https://github.com/openwrt/openwrt/commit/1e82d9f741cd827e33bfa3d8b3cadffaeb2773c1</a> 开始重新安排了linux内核的板级支持架构，以后添加新板子可以不用添加patch，只需要修改如下文件（目前仅限于 ar71xx）：</p>
<blockquote>
<p>target/linux/ar71xx/files/arch/mips/ath79/Kconfig.openwrt<br>target/linux/ar71xx/files/arch/mips/ath79/Makefile<br>target/linux/ar71xx/files/arch/mips/ath79/machtypes.h  </p>
</blockquote>
<p>对于原来修改 <code>arch/mips/ath79/Kconfig</code>的，添加到<code>Kconfig.openwrt</code>里面，以此类推，可以参考上面所述以前添加linux内核patch的说明照猫画虎。官方的这种修改避免每次添加新板子需要重新组织内核patch序列，不管是OP的核心开发者合并修改还是给项目贡献代码都很方便。</p>
<h5 id="u5F00_u59CB_u7F16_u8BD1-1"><a href="#u5F00_u59CB_u7F16_u8BD1-1" class="headerlink" title="开始编译"></a>开始编译</h5><p>再次记得, <strong>删除 tmp 目录</strong></p>
<pre><code>$ rm -rvf tmp/
$ make menuconfig
</code></pre><h4 id="u51E0_u4E2A_u95EE_u9898_u89E3_u51B3_u7684_u6848_u4F8B"><a href="#u51E0_u4E2A_u95EE_u9898_u89E3_u51B3_u7684_u6848_u4F8B" class="headerlink" title="几个问题解决的案例"></a>几个问题解决的案例</h4><h5 id="u53C2_u8003_u94FE_u63A5"><a href="#u53C2_u8003_u94FE_u63A5" class="headerlink" title="参考链接"></a>参考链接</h5><blockquote>
<p><a href="http://wiki.openwrt.org/doc/devel/add.new.device" target="_blank" rel="external">http://wiki.openwrt.org/doc/devel/add.new.device</a><br><a href="http://wiki.openwrt.org/doc/devel/hw.hacking.first.steps" target="_blank" rel="external">http://wiki.openwrt.org/doc/devel/hw.hacking.first.steps</a><br><a href="http://wiki.openwrt.org/doc/devel/patches" target="_blank" rel="external">http://wiki.openwrt.org/doc/devel/patches</a><br><a href="http://andelf.diandian.com/post/2013-05-22/40050677370" target="_blank" rel="external">http://andelf.diandian.com/post/2013-05-22/40050677370</a><br><a href="http://tilt.lib.tsinghua.edu.cn/node/841" target="_blank" rel="external">http://tilt.lib.tsinghua.edu.cn/node/841</a><br><a href="http://www.openwrt.org.cn/bbs/forum.php?mod=viewthread&amp;tid=211" target="_blank" rel="external">http://www.openwrt.org.cn/bbs/forum.php?mod=viewthread&amp;tid=211</a><br><a href="http://www.tuicool.com/kans/481707042" target="_blank" rel="external">http://www.tuicool.com/kans/481707042</a><br><a href="http://www.openwrt.org.cn/bbs/forum.php?mod=viewthread&amp;tid=60&amp;extra=page%3D1" target="_blank" rel="external">http://www.openwrt.org.cn/bbs/forum.php?mod=viewthread&amp;tid=60&amp;extra=page%3D1</a></p>
</blockquote>

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/OpenWRT/" rel="tag">#OpenWRT</a>
          
            <a href="/tags/路由器/" rel="tag">#路由器</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/02/05/ubuntu-development-environment/" rel="next" title="Ubuntu开发环境搭建">
                <i class="fa fa-chevron-left"></i> Ubuntu开发环境搭建
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2016/02/14/Tomato-shadowsocks-Scripting-Guide/" rel="prev" title="Tomato-shadowsocks Scripting Guide">
                Tomato-shadowsocks Scripting Guide <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="2016/02/05/OpenWRT-Guide/"
           data-title="OpenWRT Guide" data-url="http://yoursite.com/2016/02/05/OpenWRT-Guide/">
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="https://avatars0.githubusercontent.com/u/9395995?v=3&u=ae6055360dc7047d77121aeccdeb3a5dd4a44cf0&s=140"
               alt="HOUZI的博客" />
          <p class="site-author-name" itemprop="name">HOUZI的博客</p>
          <p class="site-description motion-element" itemprop="description">看见的，看不见了；记住了，遗忘了·····</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">6</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>
          
          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">4</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">5</span>
                <span class="site-state-item-name">标签</span>
              
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/houzi-" target="_blank">
                  
                    <i class="fa fa-github"></i> GitHub
                  
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/wojiaolinmu008" target="_blank">
                  
                    <i class="fa fa-twitter"></i> Twitter
                  
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/u/1864128991/home?wvr=5&lf=reg" target="_blank">
                  
                    <i class="fa fa-weibo"></i> Weibo
                  
                </a>
              </span>
            
          
        </div>

        
        
          <div class="cc-license motion-element" itemprop="license">
            <a href="http://creativecommons.org/licenses/by-nc-sa/4.0" class="cc-opacity" target="_blank">
              <img src="/images/cc-by-nc-sa.svg" alt="Creative Commons" />
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            <p class="site-author-name">Links</p>
            
              <span class="links-of-author-item">
                <a href="http://macshuo.com/" target="_blank">MacTalk</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://ssnxs.tk/" target="_blank">说说那些事儿</a>
              </span>
            
          
        </div>

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc-indicator-top post-toc-indicator">
            <i class="fa fa-angle-double-up"></i>
          </div>
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#u914D_u7F6E_u7F16_u8BD1_u73AF_u5883"><span class="nav-number">1.</span> <span class="nav-text">配置编译环境</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#u5B89_u88C5_u4F9D_u8D56_u5305"><span class="nav-number">1.1.</span> <span class="nav-text">安装依赖包</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#u9996_u6B21_u914D_u7F6E_u9700_u8981_u68C0_u51FA_u6E90_u4EE3_u7801_uFF0C_u8FD9_u91CC_u7528subversion_u68C0_u51FA_u5F00_u53D1trunk_u5206_u652F"><span class="nav-number">1.2.</span> <span class="nav-text">首次配置需要检出源代码，这里用subversion检出开发trunk分支</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#u66F4_u65B0_u548C_u5B89_u88C5feeds_uFF08_u9700_u8981VPN_uFF09"><span class="nav-number">1.3.</span> <span class="nav-text">更新和安装feeds（需要VPN）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#u914D_u7F6E_u7F16_u8BD1_u4FE1_u606F"><span class="nav-number">1.4.</span> <span class="nav-text">配置编译信息</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#u5F00_u59CB_u7F16_u8BD1"><span class="nav-number">2.</span> <span class="nav-text">开始编译</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#u7F16_u8BD1_u7ED3_u675F"><span class="nav-number">2.1.</span> <span class="nav-text">编译结束</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#u6E05_u7406_u4EE5_u53CA_u518D_u7F16_u8BD1"><span class="nav-number">3.</span> <span class="nav-text">清理以及再编译</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#u548C_u5B98_u65B9_u4ED3_u5E93_u4FDD_u6301_u540C_u6B65"><span class="nav-number">4.</span> <span class="nav-text">和官方仓库保持同步</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#OpenWRT__u7F16_u8BD1_doc__u6587_u4EF6"><span class="nav-number">5.</span> <span class="nav-text">OpenWRT 编译 doc 文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#u589E_u52A0_u8BBE_u5907_u652F_u6301"><span class="nav-number">6.</span> <span class="nav-text">增加设备支持</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#u524D_u63D0"><span class="nav-number">6.0.0.1.</span> <span class="nav-text">前提</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#u6240_u9700"><span class="nav-number">6.0.0.2.</span> <span class="nav-text">所需</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#u589E_u52A0_Device-Specific__u652F_u6301_u6587_u4EF6"><span class="nav-number">6.0.0.3.</span> <span class="nav-text">增加 Device-Specific 支持文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#diag-sh"><span class="nav-number">6.0.0.4.</span> <span class="nav-text">diag.sh</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#uci-defaults/01_leds"><span class="nav-number">6.0.0.5.</span> <span class="nav-text">uci-defaults/01_leds</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#uci-defaults/02_network"><span class="nav-number">6.0.0.6.</span> <span class="nav-text">uci-defaults/02_network</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#uci-defaults_u7684_u8BF4_u660E"><span class="nav-number">6.0.0.7.</span> <span class="nav-text">uci-defaults的说明</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#lib/upgrade/platform-sh"><span class="nav-number">6.0.0.8.</span> <span class="nav-text">lib/upgrade/platform.sh</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#lib/ar71xx-sh"><span class="nav-number">6.0.0.9.</span> <span class="nav-text">lib/ar71xx.sh</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#files/arch/mips/ath79/mach-tl-wdr3500-c"><span class="nav-number">6.0.0.10.</span> <span class="nav-text">files/arch/mips/ath79/mach-tl-wdr3500.c</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#u955C_u50CF_u751F_u6210_u7684_u76F8_u5173_u6587_u4EF6"><span class="nav-number">6.0.1.</span> <span class="nav-text">镜像生成的相关文件</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#trunk/target/linux/ar71xx/image/Makefile"><span class="nav-number">6.0.1.1.</span> <span class="nav-text">trunk/target/linux/ar71xx/image/Makefile</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#trunk/target/linux/ar71xx/generic/profiles/tp-link-mk"><span class="nav-number">6.0.1.2.</span> <span class="nav-text">trunk/target/linux/ar71xx/generic/profiles/tp-link.mk</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#trunk/tools/firmware-utils/src/mktplinkfw-c"><span class="nav-number">6.0.1.3.</span> <span class="nav-text">trunk/tools/firmware-utils/src/mktplinkfw.c</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#config-3-10"><span class="nav-number">6.0.1.4.</span> <span class="nav-text">config-3.10</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#patches-3-10/610-MIPS-ath79-openwrt-machines-patch"><span class="nav-number">6.0.1.5.</span> <span class="nav-text">patches-3.10/610-MIPS-ath79-openwrt-machines.patch</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#u7BA1_u7406_u8865_u4E01_u6587_u4EF6"><span class="nav-number">6.0.2.</span> <span class="nav-text">管理补丁文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#u51E0_u79CD_u7BA1_u7406_u64CD_u4F5C"><span class="nav-number">6.0.3.</span> <span class="nav-text">几种管理操作</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#u589E_u52A0_u4E00_u4E2A_u65B0_u7684Patch"><span class="nav-number">6.0.3.1.</span> <span class="nav-text">增加一个新的Patch</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#u7F16_u8F91_u4E00_u4E2A_u73B0_u6709_u7684patch"><span class="nav-number">6.0.3.2.</span> <span class="nav-text">编辑一个现有的patch</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#u65B0_u589E_u6216_u4FEE_u6539_u5185_u6838_u8865_u4E01"><span class="nav-number">6.0.3.3.</span> <span class="nav-text">新增或修改内核补丁</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#u589E_u52A0_u6216_u7F16_u8F91_u5DE5_u5177_u94FE_Patch_uFF08_u8FD9_u90E8_u5206_u4E00_u822C_u4E0D_u4F1A_u6D89_u53CA_uFF09"><span class="nav-number">6.0.3.4.</span> <span class="nav-text">增加或编辑工具链 Patch（这部分一般不会涉及）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#u5237_u65B0Patch"><span class="nav-number">6.0.3.5.</span> <span class="nav-text">刷新Patch</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#u4E0D_u6E05_u7406_u4EE3_u7801_u6811_u91CD_u590D_u4FEE_u6539_u8865_u4E01"><span class="nav-number">6.0.3.6.</span> <span class="nav-text">不清理代码树重复修改补丁</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#u51C6_u5907_linux__u5185_u6838_patch_uFF08_u65E7_uFF09"><span class="nav-number">6.0.3.7.</span> <span class="nav-text">准备 linux 内核 patch（旧）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#u51C6_u5907_linux__u5185_u6838_u677F_u7EA7_u652F_u6301_uFF08_u65B0_uFF09"><span class="nav-number">6.0.3.8.</span> <span class="nav-text">准备 linux 内核板级支持（新）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#u5F00_u59CB_u7F16_u8BD1-1"><span class="nav-number">6.0.3.9.</span> <span class="nav-text">开始编译</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#u51E0_u4E2A_u95EE_u9898_u89E3_u51B3_u7684_u6848_u4F8B"><span class="nav-number">6.0.4.</span> <span class="nav-text">几个问题解决的案例</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#u53C2_u8003_u94FE_u63A5"><span class="nav-number">6.0.4.1.</span> <span class="nav-text">参考链接</span></a></li></ol></li></ol></li></ol></li></ol></div>
            
          </div>
          <div class="post-toc-indicator-bottom post-toc-indicator">
            <i class="fa fa-angle-double-down"></i>
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="icon-next-heart fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">HOUZI的博客</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>



      </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  


  



  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>

  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=0.5.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=0.5.0"></script>



  
  

  
  
<script type="text/javascript" src="/js/src/scrollspy.js?v=0.5.0"></script>

<script type="text/javascript" id="sidebar.toc.highlight">
  $(document).ready(function () {
    var tocSelector = '.post-toc';
    var $tocSelector = $(tocSelector);
    var activeCurrentSelector = '.active-current';

    $tocSelector
      .on('activate.bs.scrollspy', function () {
        var $currentActiveElement = $(tocSelector + ' .active').last();

        removeCurrentActiveClass();
        $currentActiveElement.addClass('active-current');

        $tocSelector[0].scrollTop = $currentActiveElement.position().top;
      })
      .on('clear.bs.scrollspy', function () {
        removeCurrentActiveClass();
      });

    function removeCurrentActiveClass () {
      $(tocSelector + ' ' + activeCurrentSelector)
        .removeClass(activeCurrentSelector.substring(1));
    }

    function processTOC () {
      getTOCMaxHeight();
      toggleTOCOverflowIndicators();
    }

    function getTOCMaxHeight () {
      var height = $('.sidebar').height() -
                   $tocSelector.position().top -
                   $('.post-toc-indicator-bottom').height();

      $tocSelector.css('height', height);

      return height;
    }

    function toggleTOCOverflowIndicators () {
      tocOverflowIndicator(
        '.post-toc-indicator-top',
        $tocSelector.scrollTop() > 0 ? 'show' : 'hide'
      );

      tocOverflowIndicator(
        '.post-toc-indicator-bottom',
        $tocSelector.scrollTop() >= $tocSelector.find('ol').height() - $tocSelector.height() ? 'hide' : 'show'
      )
    }

    $(document).on('sidebar.motion.complete', function () {
      processTOC();
    });

    $('body').scrollspy({ target: tocSelector });
    $(window).on('resize', function () {
      if ( $('.sidebar').hasClass('sidebar-active') ) {
        processTOC();
      }
    });

    onScroll($tocSelector);

    function onScroll (element) {
      element.on('mousewheel DOMMouseScroll', function (event) {
          var oe = event.originalEvent;
          var delta = oe.wheelDelta || -oe.detail;

          this.scrollTop += ( delta < 0 ? 1 : -1 ) * 30;
          event.preventDefault();

          toggleTOCOverflowIndicators();
      });
    }

    function tocOverflowIndicator (indicator, action) {
      var $indicator = $(indicator);
      var opacity = action === 'show' ? 1 : 0;
      $indicator.velocity ?
        $indicator.velocity('stop').velocity({
          opacity: opacity
        }, { duration: 100 }) :
        $indicator.stop().animate({
          opacity: opacity
        }, 100);
    }

  });
</script>

<script type="text/javascript" id="sidebar.nav">
  $(document).ready(function () {
    var html = $('html');
    var TAB_ANIMATE_DURATION = 200;
    var hasVelocity = $.isFunction(html.velocity);

    $('.sidebar-nav li').on('click', function () {
      var item = $(this);
      var activeTabClassName = 'sidebar-nav-active';
      var activePanelClassName = 'sidebar-panel-active';
      if (item.hasClass(activeTabClassName)) {
        return;
      }

      var currentTarget = $('.' + activePanelClassName);
      var target = $('.' + item.data('target'));

      hasVelocity ?
        currentTarget.velocity('transition.slideUpOut', TAB_ANIMATE_DURATION, function () {
          target
            .velocity('stop')
            .velocity('transition.slideDownIn', TAB_ANIMATE_DURATION)
            .addClass(activePanelClassName);
        }) :
        currentTarget.animate({ opacity: 0 }, TAB_ANIMATE_DURATION, function () {
          currentTarget.hide();
          target
            .stop()
            .css({'opacity': 0, 'display': 'block'})
            .animate({ opacity: 1 }, TAB_ANIMATE_DURATION, function () {
              currentTarget.removeClass(activePanelClassName);
              target.addClass(activePanelClassName);
            });
        });

      item.siblings().removeClass(activeTabClassName);
      item.addClass(activeTabClassName);
    });

    $('.post-toc a').on('click', function (e) {
      e.preventDefault();
      var targetSelector = NexT.utils.escapeSelector(this.getAttribute('href'));
      var offset = $(targetSelector).offset().top;
      hasVelocity ?
        html.velocity('stop').velocity('scroll', {
          offset: offset  + 'px',
          mobileHA: false
        }) :
        $('html, body').stop().animate({
          scrollTop: offset
        }, 500);
    });

    // Expand sidebar on post detail page by default, when post has a toc.
    NexT.motion.middleWares.sidebar = function () {
      var $tocContent = $('.post-toc-content');

      if (CONFIG.sidebar.display === 'post' || CONFIG.sidebar.display === 'always') {
        if ($tocContent.length > 0 && $tocContent.html().trim().length > 0) {
          NexT.utils.displaySidebar();
        }
      }
    };
  });
</script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=0.5.0"></script>



  
    

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"router008"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementById('footer')
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
      <script src="/vendors/ua-parser-js/dist/ua-parser.min.js"></script>
      <script src="/js/src/hook-duoshuo.js"></script>
    
  



    



  
  
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
  </script>

  <script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for (i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
      }
    });
  </script>

  
    <script type="text/javascript" src="http://cdn.staticfile.org/mathjax/2.4.0/MathJax.js"></script>
    <script type="text/javascript" src="http://cdn.staticfile.org/mathjax/2.4.0/config/TeX-AMS-MML_HTMLorMML.js"></script>
  


  
  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("ukHKmMGKXX70TGsFYD65Ym8Y-gzGzoHsz", "8K9a3MFESmhL9nkhL9IsVTn0");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>




</body>
</html>
